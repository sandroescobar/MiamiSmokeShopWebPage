<% /* views/products.ejs — desktop preserved, mobile gets a dropdown toolbar */ %>

<!-- Card UI (scoped, unchanged from prior good version) -->
<style>
  :root{
    --accent:#69CEE9; --ink:#fff; --ink-dim:rgba(255,255,255,.85);
    --glass:rgba(255,255,255,.06); --glass-border:rgba(255,255,255,.14);
  }
  .product-card{display:flex;flex-direction:column;background:var(--glass);border:1px solid var(--glass-border);border-radius:16px;overflow:hidden;backdrop-filter:blur(6px);box-shadow:0 12px 26px rgba(0,0,0,.25);transition:transform .15s, box-shadow .15s;min-height:300px;}
  .product-card:hover{transform:translateY(-3px);box-shadow:0 16px 36px rgba(0,0,0,.35)}
  .product-media{position:relative;width:100%;height:210px;min-height:210px;overflow:hidden;background:white;display:flex;align-items:center;justify-content:center;padding:0}
  .product-media img{width:auto;height:auto;max-width:88%;max-height:88%;object-fit:contain;display:block;padding:0;transition:transform .2s ease}
  .product-media img[src*="LOST%20MARY%20TURBO%2035K"][src*="STRAWMELONPEACH"],
  .product-media img[src*="LOST%20MARY%20TURBO%2035K"][src*="WATERMELONICE"]{
    object-fit:contain;
    transform-origin:center;
  }
  .product-media img[src*="LOST%20MARY%20TURBO%2035K"][src*="STRAWMELONPEACH"]{
    transform:translateX(12px) scale(1.35);
    object-position:62% 55%;
    position: relative;
    top: 10%;
    left: 5%;
  }
  .product-media img[src*="LOST%20MARY%20TURBO%2035K"][src*="WATERMELONICE"]{
    transform:scale(1.30);
    object-position:center;
    position: relative;
    right: 10%;
    height: 120%;
  }

  .product-media img[src*="CUVIE%20PLUS"]{
    object-fit:contain;
    width:auto;
    height:90%;
    max-width:none;
    max-height:none;
    padding:0;
    transform:translateY(4%) scale(1.08);
    transform-origin:center;
  }
  .product-media img[src*="FUME%20EXTRA"]{
    object-fit:contain;
    width:auto;
    height:110%;
    max-width:100%;
    max-height:120%;
    padding:0 6px;
    transform:none;
  }
  .product-media img[src*="BB%20PEN%201GR"]{
    object-fit:contain;
    width:auto;
    height:auto;
    max-width:92%;
    max-height:92%;
    transform:scale(1.08);
    transform-origin:center;
    object-position:center;
  }
  .product-media img[src*="BB%20CART%201GR"]{
    object-fit:contain;
    width:auto;
    height:auto;
    max-width:90%;
    max-height:90%;
    transform:scale(1.05);
    transform-origin:center;
    object-position:center;
  }
  .product-media img[src*="BB%20MOONROCK%20PRE%20ROLL%202GR"][src*="SATIVADESERTSKUNK"]{
    object-fit:contain;
    width:auto;
    height:100%;
    max-width:100%;
    transform:scale(.92);
    transform-origin:center;
    object-position:center;
  }
  .product-media img[src*="BB%20MOONROCK%20PRE%20ROLL%202GR"][src*="INDICATROPICANACOOKIES"]{
    object-fit:contain;
    width:auto;
    height:100%;
    max-width:100%;
    transform:scale(.92);
    transform-origin:center;
    object-position:center;
  }



 .product-media img[src*="FUME%20EXTRA"][src*="BANANAICE"]{
    object-fit:contain;
    width:180%;
    height:180%;
    padding:0 6px;
    transform:none;
  }
  .wishlist{position:absolute;right:.4rem;top:.4rem;width:28px;height:28px;border-radius:10px;border:1px solid rgba(255,255,255,.25);background:rgba(0,0,0,.45);color:#fff;display:grid;place-items:center}
  .wishlist svg{width:14px;height:14px}
  .product-info{flex:1;padding:.2rem .45rem .35rem;display:flex;flex-direction:column;gap:.14rem}
  .product-name{font-size:.85rem;margin:0;color:#fff;line-height:1.12}
  .buy-row{display:flex;align-items:center;justify-content:space-between;gap:.25rem;margin-top:.05rem}
  .price{font-weight:600;font-size:.95rem}
  .btn-accent{border:0;padding:.4rem .6rem;border-radius:10px;cursor:pointer;background:var(--accent);color:#0a1222;font-weight:600;font-size:.85rem}
  .sold-out,.product-card.sold-out .btn-accent{pointer-events:none;opacity:.6}
  
  /* Flavor carousel */
  .product-name-section{display:flex;flex-direction:column;gap:.12rem}
  .flavor-label{font-size:.62rem;letter-spacing:.05em;text-transform:lowercase;opacity:.65; padding-top: 0.5rem;}
  .flavor-carousel{display:flex;align-items:center;justify-content:space-between;background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.18);border-radius:6px;padding:0;min-height:26px;gap:.2rem;margin-top:.05rem margin-bottom:1.2rem}
  .flavor-nav-btn{background:transparent;border:none;color:var(--ink);padding:0 .3rem;cursor:pointer;font-size:.7rem;transition:opacity .15s;flex-shrink:0;height:100%;display:grid;place-items:center;min-width:20px}
  .flavor-nav-btn:hover{opacity:.8}
  .flavor-nav-btn:disabled{opacity:.4;pointer-events:none}
  .flavor-display{flex:1;text-align:center;font-size:.7rem;color:var(--ink-dim);padding:0 .25rem;display:flex;align-items:center;justify-content:center;min-width:0}
  .flavor-text{display:block;white-space:nowrap;padding:0;overflow:visible}
  .soldout-overlay{position:absolute;inset:0;background:rgba(8,18,31,.6);display:grid;place-items:center;text-transform:uppercase;letter-spacing:.18em;font-weight:600;color:#fff}
  .no-image-badge{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,.55);color:#fff;font-weight:600;font-size:.9rem;padding:.5rem .75rem;border-radius:10px;border:1px solid rgba(255,255,255,.25);text-align:center;pointer-events:none}
  .no-image-badge.is-hidden{display:none}

  /* ---------- Toolbar: desktop vs mobile (scoped) ---------- */
  .product-toolbar .toolbar-desktop{display:flex;gap:12px;align-items:center}
  .product-toolbar .toolbar-desktop .searchbox{position:relative;flex:1}
  .product-toolbar .toolbar-desktop .searchbox input{width:100%;height:42px;border-radius:10px;padding:0 42px 0 14px;border:none;background:transparent;color:var(--ink)}
  .product-toolbar .toolbar-desktop .searchbox .ico{position:absolute;right:12px;top:50%;transform:translateY(-50%);opacity:.75}
  .product-toolbar .toolbar-desktop select{height:42px;border-radius:10px;padding:0 12px;background:rgba(255,255,255,.06);color:var(--ink);border:1px solid rgba(255,255,255,.12)}
  .product-toolbar .toolbar-desktop button{height:42px;border-radius:10px}

  /* Mobile dropdown toolbar */
  .product-toolbar .toolbar-mobile{display:none}
  @media (max-width: 768px){
    .product-toolbar .toolbar-desktop{display:none}
    .product-toolbar .toolbar-mobile{display:block}
    .toolbar-mobile details{border:1px solid rgba(255,255,255,.12);border-radius:12px;background:rgba(255,255,255,.04)}
    .toolbar-mobile summary{list-style:none;padding:12px 14px;font-weight:600;display:flex;justify-content:space-between;align-items:center;cursor:pointer}
    .toolbar-mobile summary::after{content:"▾";opacity:.85}
    .toolbar-mobile[open] summary::after{content:"▴"}
    .toolbar-mobile .sheet{padding:12px 14px 16px;display:grid;gap:10px}
    .toolbar-mobile .sheet input[type="search"], .toolbar-mobile .sheet select{height:48px;border-radius:10px;padding:0 12px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);color:var(--ink)}
    .toolbar-mobile .sheet button{height:48px;border-radius:10px}
  }

  /* Chips: allow horizontal scroll on phones, no change desktop */
  @media (max-width: 768px){
    .hero-chips{display:flex;gap:8px;overflow-x:auto;padding:4px 6px;margin-inline:-12px;scroll-snap-type:x mandatory}
    .hero-chips > *{scroll-snap-align:start;white-space:nowrap}
  }

  @media (max-width: 640px){
    .product-grid{
      display:grid;
      grid-template-columns:repeat(2,minmax(0,1fr));
      gap:.55rem;
      padding:.75rem .5rem 1.2rem;
    }
    .product-card{min-height:0}
    .product-card .product-media{height:180px;min-height:180px}
    .product-card .product-media img{max-width:80%;max-height:80%}
    .product-card .buy-row{flex-direction:column;align-items:flex-start;gap:.25rem}
    .product-card .btn-accent{width:100%;text-align:center}
    .product-card .price{font-size:.9rem}
  }
</style>

<!-- HERO (unchanged structure) -->
<header class="hero-products">
  <div class="hero-inner container">
    <h1 class="hero-title">Shop Products</h1>
    <p class="hero-sub">Same-day pickup or delivery from either location.</p>
    <div class="hero-chips">
      <span>Best prices</span>
      <span>Open late</span>
      <span>Miami pickup &amp; delivery</span>
    </div>
  </div>
</header>

<!-- TOOLBAR -->
<section class="product-toolbar container">

  <!-- DESKTOP toolbar (preserved) -->
  <form method="get" class="toolbar-desktop" role="search" aria-label="Filter products">
    <div class="searchbox">
      <input type="search" name="q" placeholder="Search products…" value="<%= q || '' %>" aria-label="Search products">
      <svg class="ico" viewBox="0 0 24 24" width="20" height="20" aria-hidden="true">
        <path d="M21 21l-4.2-4.2M10.5 18a7.5 7.5 0 1 1 0-15 7.5 7.5 0 0 1 0 15z" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
    </div>

    <select name="sort" aria-label="Sort">
      <option value="newest"     <%= sort==='newest'     ? 'selected' : '' %>>Newest</option>
      <option value="price_asc"  <%= sort==='price_asc'  ? 'selected' : '' %>>Price: Low → High</option>
      <option value="price_desc" <%= sort==='price_desc' ? 'selected' : '' %>>Price: High → Low</option>
    </select>

    <select name="category" aria-label="Filter by Category">
      <option value="">All Categories</option>
      <% (categories || []).forEach(cat => { %>
        <option value="<%= cat.id %>" <%= category == cat.id ? 'selected' : '' %>><%= cat.name %></option>
      <% }) %>
    </select>

    <div class="toolbar-actions">
      <button class="btn btn-sm btn-light" type="submit">Apply</button>
      <% if (q || category || sort !== 'newest') { %>
        <a class="btn btn-sm btn-outline-light" href="/products">Clear</a>
      <% } %>
    </div>
  </form>

  <!-- MOBILE toolbar (collapsible) -->
  <div class="toolbar-mobile">
    <details>
      <summary>Filters</summary>
      <div class="sheet">
        <input type="search" name="q" form="mobile-filters" placeholder="Search products…" value="<%= q || '' %>" aria-label="Search products">
        <select name="sort" form="mobile-filters" aria-label="Sort">
          <option value="newest"     <%= sort==='newest'     ? 'selected' : '' %>>Newest</option>
          <option value="price_asc"  <%= sort==='price_asc'  ? 'selected' : '' %>>Price: Low → High</option>
          <option value="price_desc" <%= sort==='price_desc' ? 'selected' : '' %>>Price: High → Low</option>
        </select>

        <select name="category" form="mobile-filters" aria-label="Filter by Category">
          <option value="">All Categories</option>
          <% (categories || []).forEach(cat => { %>
            <option value="<%= cat.id %>" <%= category == cat.id ? 'selected' : '' %>><%= cat.name %></option>
          <% }) %>
        </select>
        <form id="mobile-filters" method="get" style="display:grid;gap:8px;">
          <!-- inputs/select above submit with this form via form="" attribute -->
          <button class="btn btn-light w-100" type="submit">Apply</button>
          <% if (q || category || sort !== 'newest') { %>
            <a class="btn btn-outline-light w-100" href="/products">Clear</a>
          <% } %>
        </form>
      </div>
    </details>
  </div>

  <!-- Results count -->
  <div class="results container--narrow" aria-live="polite" style="text-align:center;opacity:.9;margin-top:10px">
    <% if ((products || []).length) { %>
      Showing <%= products.length %> of <%= total %> results <% if (q) { %> for “<%= q %>” <% } %>
    <% } else { %>
      No products found <% if (q) { %> for “<%= q %>” <% } %>
    <% } %>
  </div>
</section>

<!-- GRID -->
<main class="container product-grid">
  <% (products || []).forEach(p => {
       const isGrouped = p.variants && p.variants.length > 0;
       const variants = p.variants || [p];
       const firstVariant = variants[0] || {};
       const anyAvailable = variants.some(v => Number(v.total_qty || 0) > 0);
       let defaultVariantIndex = variants.findIndex(v => Number(v.total_qty || 0) > 0);
       if (defaultVariantIndex === -1) defaultVariantIndex = 0;
       const displayVariant = variants[defaultVariantIndex] || firstVariant;
       const displayQty = Number(displayVariant.total_qty || 0);
       const displayAvailable = displayQty > 0;
       const price = (firstVariant.price != null) ? ('$' + Number(firstVariant.price).toFixed(2)) : '—';
       const hasImage = !!displayVariant.has_image;
       const imgSrc = displayVariant.image_url || '/images/products/placeholder.webp';
       const alt = (displayVariant.image_alt || 'Image coming soon') + ' - ' + (displayVariant.name || p.name);
  %>
    <article class="product-card <%= !anyAvailable ? 'sold-out' : '' %>" data-product-id="<%= displayVariant.id || firstVariant.id %>" data-product-price="<%= firstVariant.price || 0 %>" data-product-name="<%= p.base_name || p.name %>" data-is-grouped="<%= isGrouped ? 'true' : 'false' %>">
      <div class="product-media">
        <img src="<%= imgSrc %>" alt="<%= alt %>">
        <div class="no-image-badge <%= hasImage ? 'is-hidden' : '' %>"><%= (displayVariant.image_alt || firstVariant.image_alt || 'Image coming soon') %></div>
        <% if (!anyAvailable) { %><div class="soldout-overlay">Sold out</div><% } %>
      </div>

      <div class="product-info">
        <div class="product-name-section">
          <h3 class="product-name"><%= p.base_name || p.name %></h3>
          <% if (isGrouped && variants.length > 1) { %>
            <div>
              <div class="flavor-label">Flavors</div>
              <div class="flavor-carousel" data-flavor-index="<%= defaultVariantIndex %>">
                <button class="flavor-nav-btn prev-flavor">‹</button>
                <div class="flavor-display">
                  <span class="flavor-text"><%= variants[defaultVariantIndex]?.flavor || variants[0]?.flavor %></span>
                </div>
                <button class="flavor-nav-btn next-flavor">›</button>
                <% variants.forEach((v, idx) => { %>
                  <input type="hidden"
                         class="flavor-variant"
                         data-idx="<%= idx %>"
                         data-variant-id="<%= v.id %>"
                         data-flavor="<%= v.flavor %>"
                         data-qty="<%= Number(v.total_qty || 0) %>"
                         data-image="<%= v.image_url %>"
                         data-image-alt="<%= v.image_alt %>"
                         data-has-image="<%= v.has_image ? 'true' : 'false' %>">
                <% }) %>
              </div>
            </div>
          <% } %>
        </div>

        <div class="buy-row">
          <span class="price"><%= price %></span>
          <button class="btn-accent"
                  data-primary-btn="true"
                  data-stock-label-available="Add to cart"
                  data-stock-label-out="Out of stock"
                  <%= (!anyAvailable || !displayAvailable) ? 'disabled' : '' %>>
            <%= (!anyAvailable || !displayAvailable) ? 'Out of stock' : 'Add to cart' %>
          </button>
        </div>
      </div>
    </article>
  <% }) %>
</main>

<!-- PAGINATION -->
<nav class="container pagination-bar" aria-label="Products pages">
  <%
    const pages = Math.max(Math.ceil((total || 0) / (pageSize || 24)), 1);
    const prev = Math.max((page||1) - 1, 1);
    const next = Math.min((page||1) + 1, pages);
    const qs = (p) =>
      `?page=${p}` +
      `&page_size=${pageSize||24}` +
      `${q ? `&q=${encodeURIComponent(q)}` : ''}` +
      `${sort ? `&sort=${encodeURIComponent(sort)}` : ''}` +
      `${category ? `&category=${encodeURIComponent(category)}` : ''}`;
  %>
  <a class="pager page-prev" href="<%= qs(prev) %>" aria-disabled="<%= (page||1)===1 %>">‹ Prev</a>
  <span class="pager page-current" aria-current="page"><%= page || 1 %> / <%= pages %></span>
  <a class="pager page-next" href="<%= qs(next) %>">Next ›</a>
</nav>
