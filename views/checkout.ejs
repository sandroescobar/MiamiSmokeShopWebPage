<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title><%= title || 'Checkout' %></title>

  <!-- Keep your existing CSS includes if you have them -->
  <link rel="stylesheet" href="/css/checkout.css">
  <style>
    /* Minimal fallback styling so the page is usable even if checkout.css is missing */
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#f6f7fb;color:#111;}
    .wrap{max-width:980px;margin:24px auto;padding:0 16px;display:grid;grid-template-columns:1fr 360px;gap:18px}
    @media (max-width:900px){.wrap{grid-template-columns:1fr}}
    .card{background:#fff;border:1px solid #e6e6ef;border-radius:12px;padding:16px}
    h2{margin:0 0 12px 0;font-size:18px}
    label{display:block;font-size:12px;color:#444;margin:10px 0 6px}
    input{width:100%;padding:10px 12px;border:1px solid #d6d6e6;border-radius:10px;font-size:14px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .btn{width:100%;padding:12px 14px;border:0;border-radius:10px;background:#4fc3df;color:#fff;font-weight:700;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .muted{color:#666;font-size:12px;margin-top:6px}
    .err{color:#b00020;font-size:13px;margin-top:10px;white-space:pre-wrap}
    .sumrow{display:flex;justify-content:space-between;margin:8px 0;font-size:14px}
    .sumrow.total{font-weight:800;font-size:16px}
  </style>
</head>

<body>
  <div class="wrap">
    <!-- Left: Contact + Payment -->
    <div class="card">
      <h2>Contact</h2>

      <label>Email address</label>
      <input id="email" type="email" value="<%= (typeof user !== 'undefined' && user && user.email) ? user.email : '' %>
" placeholder="you@example.com" />

      <div class="row">
        <div>
          <label>First name</label>
          <input id="firstName" type="text" value="" placeholder="First" />
        </div>
        <div>
          <label>Last name</label>
          <input id="lastName" type="text" value="" placeholder="Last" />
        </div>
      </div>

      <label>Phone number</label>
      <input id="phoneNumber" type="tel" value="" placeholder="(xxx) xxx-xxxx" />

      <h2 style="margin-top:18px;">Payment</h2>

      <label>Name on card</label>
      <input id="cardName" type="text" placeholder="Name as it appears on card" />

      <label>Card number</label>
      <input id="cardNumber" type="text" inputmode="numeric" autocomplete="cc-number" placeholder="•••• •••• •••• ••••" />

      <div class="row">
        <div>
          <label>Expiration (MM/YY)</label>
          <input id="cardExp" type="text" inputmode="numeric" autocomplete="cc-exp" placeholder="MM/YY" />
        </div>
        <div>
          <label>CVV</label>
          <input id="cardCvv" type="text" inputmode="numeric" autocomplete="cc-csc" placeholder="123" />
        </div>
      </div>

      <div class="muted">Your card details are tokenized by Authorize.Net (Accept.js). We never store raw card numbers on our server.</div>
      <div id="err" class="err" style="display:none;"></div>
    </div>

    <!-- Right: Order Summary -->
    <div class="card">
      <h2>Order Summary</h2>

      <div class="sumrow"><span>Subtotal</span><span id="subtotal">$0.00</span></div>
      <div class="sumrow"><span>Tax</span><span id="tax">$0.00</span></div>
      <div class="sumrow"><span>Delivery</span><span id="delivery">$0.00</span></div>
      <div class="sumrow total"><span>Total</span><span id="total">$0.00</span></div>

      <button id="completeOrderBtn" class="btn" type="button" style="margin-top:14px;">Complete Order</button>
      <div class="muted" id="authnetDebug"></div>
    </div>
  </div>

  <% const env = (authorizeEnv || '').toLowerCase(); %>
  <% if (env === 'production') { %>
    <script src="https://js.authorize.net/v1/Accept.js" charset="utf-8"></script>
  <% } else { %>
    <script src="https://jstest.authorize.net/v1/Accept.js" charset="utf-8"></script>
  <% } %>

  <script>
    // Injected by server (public values only)
    const AUTHNET = {
      loginId: "<%= (authorizeLoginId || '') %>",
      clientKey: "<%= (authorizeClientKey || '') %>",
      env: "<%= (authorizeEnv || '') %>"
    };

    // Basic totals calculation from localStorage cart (adjust if your cart schema differs)
    // Expected cart item shape examples:
    // - { price: 9.99, quantity: 2 }
    // - { price: "9.99", qty: 2 }
    function getCartTotals() {
      let cart = [];
      try { cart = JSON.parse(localStorage.getItem('cart') || '[]'); } catch {}
      const subtotal = cart.reduce((sum, it) => {
        const p = Number(it.price ?? it.unitPrice ?? 0);
        const q = Number(it.quantity ?? it.qty ?? 1);
        if (!Number.isFinite(p) || !Number.isFinite(q)) return sum;
        return sum + (p * q);
      }, 0);

      const taxRate = 0.0875; // 8.75%
      const tax = subtotal * taxRate;
      const delivery = 0;     // set if you add delivery logic
      const total = subtotal + tax + delivery;

      return { subtotal, tax, delivery, total };
    }

    function money(n) {
      const x = Number(n || 0);
      return '$' + (Number.isFinite(x) ? x.toFixed(2) : '0.00');
    }

    function renderTotals() {
      const t = getCartTotals();
      document.getElementById('subtotal').textContent = money(t.subtotal);
      document.getElementById('tax').textContent = money(t.tax);
      document.getElementById('delivery').textContent = money(t.delivery);
      document.getElementById('total').textContent = money(t.total);
      return t;
    }

    function showErr(msg) {
      const el = document.getElementById('err');
      el.style.display = 'block';
      el.textContent = msg || 'Payment failed.';
    }

    function clearErr() {
      const el = document.getElementById('err');
      el.style.display = 'none';
      el.textContent = '';
    }

    function parseExp(exp) {
      // Accepts "MM/YY" or "MM/YYYY"
      const raw = String(exp || '').trim();
      const m = raw.match(/^(\d{1,2})\s*\/\s*(\d{2,4})$/);
      if (!m) return null;
      let mm = m[1].padStart(2, '0');
      let yy = m[2];
      if (yy.length === 2) yy = '20' + yy;
      return { month: mm, year: yy };
    }

    async function submitCharge(opaqueData, totals) {
      const billing = {
        firstName: document.getElementById('firstName').value.trim(),
        lastName: document.getElementById('lastName').value.trim(),
        phoneNumber: document.getElementById('phoneNumber').value.trim(),
        address: '',
        city: '',
        state: '',
        zip: '',
        country: 'US'
      };
      const customer = { email: document.getElementById('email').value.trim() };

      // If you have delivery logic, set these appropriately
      const deliveryMethod = 'pickup';
      const pickupStore = "<%= (storeMeta && storeMeta.label) ? storeMeta.label : (selectedShop || 'Calle 8') %>";

      const payload = {
        opaqueData,               // { dataDescriptor, dataValue }
        billing,
        customer,
        deliveryMethod,
        pickupStore,
        selectedDeliveryStore: null,
        totals
      };

      const resp = await fetch('/api/authorize/charge', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      const data = await resp.json().catch(() => ({}));
      if (!resp.ok || !data.ok) {
        throw new Error(data.error || 'Payment failed.');
      }
      return data;
    }

    function tokenizeAndPay() {
      clearErr();

      // Basic config sanity
      const dbg = document.getElementById('authnetDebug');
      dbg.textContent = `[checkout] authnet config { loginIdPresent: ${!!AUTHNET.loginId}, clientKeyPresent: ${!!AUTHNET.clientKey}, env: '${AUTHNET.env || 'unset'}' }`;

      if (!AUTHNET.loginId || !AUTHNET.clientKey) {
        showErr('Authorize.Net is not configured (missing loginId/clientKey).');
        return;
      }

      const totals = renderTotals();
      if (!totals || totals.total <= 0) {
        showErr('Your cart total is $0.00. Add an item before checking out.');
        return;
      }

      const exp = parseExp(document.getElementById('cardExp').value);
      if (!exp) {
        showErr('Invalid expiration date. Use MM/YY.');
        return;
      }

      const secureData = {
        authData: {
          clientKey: AUTHNET.clientKey,
          apiLoginID: AUTHNET.loginId
        },
        cardData: {
          cardNumber: document.getElementById('cardNumber').value.replace(/\s+/g,''),
          month: exp.month,
          year: exp.year,
          cardCode: document.getElementById('cardCvv').value.trim()
        }
      };

      // Accept.js callback
      const responseHandler = async function(response) {
        try {
          if (response.messages && response.messages.resultCode === "Error") {
            const msg = (response.messages.message && response.messages.message[0] && response.messages.message[0].text) || 'Payment tokenization failed.';
            showErr(msg);
            return;
          }

          const opaqueData = response.opaqueData;
          if (!opaqueData || !opaqueData.dataDescriptor || !opaqueData.dataValue) {
            showErr('Tokenization did not return opaqueData. Please try again.');
            return;
          }

          const btn = document.getElementById('completeOrderBtn');
          btn.disabled = true;

          const result = await submitCharge(opaqueData, totals);

          // Success: you can redirect to an order confirmation page if you have one
          // window.location.href = '/order-confirmation?tx=' + encodeURIComponent(result.transactionId);
          alert('Payment successful! Transaction ID: ' + result.transactionId);

        } catch (e) {
          showErr(e.message || 'Payment failed.');
        } finally {
          document.getElementById('completeOrderBtn').disabled = false;
        }
      };

      if (typeof Accept === 'undefined' || !Accept.dispatchData) {
        showErr('Authorize.Net Accept.js failed to load. Please refresh and try again.');
        return;
      }

      Accept.dispatchData(secureData, responseHandler);
    }

    document.getElementById('completeOrderBtn').addEventListener('click', tokenizeAndPay);
    renderTotals();
  </script>
</body>
</html>
