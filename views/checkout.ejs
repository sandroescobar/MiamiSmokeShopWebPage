<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Secure checkout</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#ffffff;
      --ink:#0f172a;
      --ink-dim:#475569;
      --ink-soft:#64748b;
      --line:#e2e8f0;
      --brand:#111827;
      --brand-ink:#ffffff;
      --pill:#f1f5f9;
      --focus:#4f46e5;
      --ok:#16a34a;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--ink);
      font: 14px/1.4 Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
    }

    /* Page shell */
    .page{
      max-width: 1200px; margin: 24px auto; padding: 0 16px 48px;
    }
    .mast{display:flex; align-items:center; gap:12px; margin: 6px 0 18px;}
    .mast h1{font-size:28px; margin:0; font-weight:700}
    .eyebrow{font-size:13px; color:var(--ink-soft); margin-bottom: 18px;}

    /* Layout */
    .grid{
      display:grid; gap: 24px;
      grid-template-columns: 1fr 360px;
    }
    @media (max-width: 960px){
      .grid{grid-template-columns: 1fr}
    }

    /* Cards */
    .card{
      background:var(--card); border:1px solid var(--line);
      border-radius:12px; box-shadow: 0 4px 14px rgba(15,23,42,.06);
    }
    .card .card-body{ padding: 18px; }
    .section{margin-bottom: 18px;}
    .section h3{
      font-size: 14px; letter-spacing:.02em; text-transform: uppercase;
      color:var(--ink-dim); margin: 0 0 10px; font-weight:700;
    }

    /* Option pills (pickup / delivery) */
    .option-row{
      display:grid; gap:12px; grid-template-columns: 1.2fr 1.2fr;
    }
    @media (max-width: 600px){ .option-row{grid-template-columns:1fr} }
    .option{
      position:relative; border:1px solid var(--line); border-radius:12px; background:#fff;
      padding:14px; display:flex; gap:12px; align-items:center; cursor:pointer;
    }
    .option input{ position:absolute; inset:0; opacity:0; }
    .option .icon{
      width:28px; height:28px; border-radius:8px; display:grid; place-items:center; background:var(--pill);
      font-size:16px;
    }
    .option .title{ font-weight:600; }
    .option .sub{ color:var(--ink-soft); font-size:13px; }
    .option:has(input:checked){
      border-color: var(--focus); box-shadow:0 0 0 4px rgba(79,70,229,.12);
    }

    /* Form fields */
    .row{ display:grid; gap:12px; grid-template-columns: 1.2fr 1.2fr; }
    .row-1{ grid-template-columns: 1fr; }
    @media (max-width: 680px){ .row{grid-template-columns:1fr} }

    label{ display:block; font-weight:600; font-size:13px; margin: 8px 0 6px; color:var(--ink) }
    input, select, textarea{
      width:100%; border:1px solid var(--line); background:#fff; color:var(--ink);
      border-radius:10px; padding:12px 14px; font: inherit; outline: none;
    }
    input:focus, select:focus, textarea:focus{ border-color:var(--focus); box-shadow:0 0 0 3px rgba(79,70,229,.15); }

    /* Order summary */
    .summary .totals{ border-top:1px solid var(--line); margin-top: 14px; padding-top: 14px; }
    .line{ display:flex; justify-content:space-between; margin: 8px 0; }
    .grand{ font-weight:800; font-size:18px; }

    /* Store selection */
    .store-selector { margin-top: 12px; }
    .store-option {
      position: relative; border: 1px solid var(--line); border-radius: 10px; 
      background: #fff; padding: 12px 14px; margin-bottom: 10px; cursor: pointer;
      transition: all 0.2s;
    }
    .store-option:hover { border-color: var(--focus); }
    .store-option input { position: absolute; inset: 0; opacity: 0; }
    .store-option .store-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; }
    .store-option .store-name { font-weight: 600; }
    .store-option .availability { font-size: 11px; padding: 2px 8px; border-radius: 6px; background: var(--pill); }
    .store-option .availability.available { background: #dcfce7; color: #166534; }
    .store-option .availability.unavailable { background: #fee2e2; color: #991b1b; }
    .store-option .store-address { font-size: 12px; color: var(--ink-soft); margin-bottom: 4px; }
    .store-option .store-distance { font-size: 12px; color: var(--ink-soft); }
    .store-option:has(input:checked) { border-color: var(--focus); box-shadow: 0 0 0 3px rgba(79,70,229,.15); }

    .availability-notice { font-size: 13px; color: #475569; margin-top: 10px; padding: 10px; 
      background: #f1f5f9; border-radius: 8px; border-left: 3px solid var(--focus); }
    .loading { color: var(--ink-soft); font-size: 13px; margin-top: 8px; }

    /* Buttons */
    .btn{
      display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding:12px 16px; border-radius:10px; border:1px solid transparent;
      cursor:pointer; font-weight:700; text-decoration:none;
    }
    .btn-primary{ background:var(--brand); color:var(--brand-ink); }
    .btn-secondary{ background:#fff; border-color:var(--line); color:var(--ink) }
    .btn:disabled{ opacity:.6; pointer-events:none }

    .actions{ display:flex; gap:12px; margin-top:14px; flex-wrap:wrap; justify-content: center; align-items: center}
  </style>
</head>
<body>





  <div class="page">
    <div class="mast">
      <h1>Secure checkout</h1>
    </div>
    <div class="eyebrow">Pick up in-store or get fast Uber Delivery</div>

    <div class="grid">
      <!-- LEFT: form -->
      <div>
        <div class="card">
          <div class="card-body">
            <div class="section">
              <h3>Delivery options</h3>
              <div class="option-row">
                <label class="option">
                  <input type="radio" name="delivery_method" value="pickup" checked>
                  <div class="icon">üè™</div>
                  <div>
                    <div class="title">Store pickup</div>
                    <div class="sub">Free pickup at our Miami location</div>
                  </div>
                </label>

                <label class="option">
                  <input type="radio" name="delivery_method" value="uber">
                  <div class="icon">üõµ</div>
                  <div>
                    <div class="title">Uber Delivery</div>
                    <div class="sub">On-demand courier to your door</div>
                  </div>
                </label>
              </div>

              <!-- Store Selection (Pickup) -->
              <div id="pickup-stores-section" style="margin-top: 16px;">
                <h3 style="margin-top: 12px; margin-bottom: 8px;">Select pickup location</h3>
                <div id="pickup-stores" class="store-selector"></div>
                <div id="pickup-availability-notice" class="availability-notice" style="display:none;"></div>
              </div>

              <!-- Store Detection (Delivery) -->
              <div id="delivery-stores-section" style="margin-top: 16px; display:none;">
                <h3 style="margin-top: 12px; margin-bottom: 8px;">Delivery to</h3>
                <div id="delivery-availability-notice" class="availability-notice" style="display:none;"></div>
                <div id="closest-store-info" style="margin-top: 10px; padding: 10px; background: #f0f9ff; border-radius: 8px; border-left: 3px solid #0284c7; display:none;">
                  <div style="font-weight: 600; margin-bottom: 4px;">üìç <span id="closest-store-name"></span></div>
                  <div style="font-size: 12px; color: #475569; margin-bottom: 2px;"><span id="closest-store-address"></span></div>
                  <div style="font-size: 12px; color: #0284c7; font-weight: 500;">~<span id="closest-store-distance"></span> miles away</div>
                </div>
              </div>
            </div>

            <div class="section">
              <h3>Contact</h3>
              <div class="row-1">
                <label>Email address
                  <input type="email" name="email" placeholder="you@email.com" required>
                </label>
              </div>
              <div class="row">
                <label>First name
                  <input type="text" name="first_name" placeholder="First name" required>
                </label>
                <label>Last name
                  <input type="text" name="last_name" placeholder="Last name" required>
                </label>
              </div>
              <div class="row-1">
                <label>Phone number
                  <input type="tel" name="phone" placeholder="(305) 555-0123" required>
                </label>
              </div>
            </div>

            <div class="section" id="address-section">
              <h3>Delivery address</h3>
              <div class="row-1">
                <label>Street address
                  <input type="text" name="street" placeholder="123 Main Street">
                </label>
              </div>
              <div class="row">
                <label>City
                  <input type="text" name="city" placeholder="Miami">
                </label>
                <label>State
                  <input type="text" name="state" placeholder="FL">
                </label>
              </div>
              <div class="row-1">
                <label>ZIP Code
                  <input type="text" name="zip" placeholder="33101">
                </label>
              </div>
            </div>

            <div class="section">
              <h3>Payment</h3>
              <div class="row-1">
                <div class="card" style="border-style:dashed">
                  <div class="card-body" style="color:var(--ink-soft)">
                    Stripe integration will be added here
                  </div>
                </div>
              </div>
              <div class="actions">
                <button class="btn btn-primary" type="submit" form="checkout-form">Complete order</button>
                <a class="btn btn-secondary" href="/cart">Back to cart</a>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- RIGHT: order summary -->
      <aside class="summary">
        <div class="card">
          <div class="card-body">
            <h3 style="margin-top:0; text-transform:none; letter-spacing:0; font-size:16px;">Order summary</h3>

            <div id="order-items-container"></div>

            <div class="totals">
              <div class="line"><span>Subtotal</span><span id="summary-subtotal">$0.00</span></div>
              <div class="line"><span>Delivery</span><span id="summary-delivery">$0.00</span></div>
              <div class="line"><span>Tax (est)</span><span id="summary-tax">$0.00</span></div>
              <div class="line grand"><span>Total</span><span id="summary-total">$0.00</span></div>
            </div>

            <div class="actions" style="margin-top:16px">
              <button class="btn btn-primary" type="submit" form="checkout-form" style="width:100%">Complete order</button>
              <a class="btn btn-secondary" href="/cart" style="width:100%">Back to cart</a>
            </div>
          </div>
        </div>
      </aside>
    </div>

    <!-- The actual form tag (separate so buttons can live in cards and still submit) -->
    <form id="checkout-form" action="/checkout" method="POST"></form>
  </div>

  <script>
    // Global state
    let allStores = [];
    let selectedStore = null;
    let cartProductIds = [];

    // Render cart items and update totals
    (function(){
      const cart = JSON.parse(localStorage.getItem('cart')) || [];
      const container = document.getElementById('order-items-container');
      const TAX_RATE = 0.0875;
      
      // Extract product IDs from cart for inventory checks
      cartProductIds = cart.map(item => item.id).filter(Boolean);
      
      if (cart.length === 0) {
        container.innerHTML = '<p style="color:#64748b; margin-bottom:16px;">Your cart is empty</p>';
      } else {
        let itemsHtml = '';
        let subtotal = 0;
        
        cart.forEach(item => {
          const price = typeof item.price === 'string' ? parseFloat(item.price.replace('$', '')) : (item.price || 0);
          const itemTotal = price * (item.quantity || 1);
          subtotal += itemTotal;
          itemsHtml += `
            <div class="line" style="font-size:13px; padding:8px 0;">
              <span>${item.name} <span style="color:#64748b;">√ó${item.quantity}</span></span>
              <span>$${itemTotal.toFixed(2)}</span>
            </div>
          `;
        });
        
        const tax = subtotal * TAX_RATE;
        const delivery = 0;
        const total = subtotal + tax + delivery;
        
        container.innerHTML = itemsHtml + '<div style="border-bottom:1px solid #e2e8f0; margin-bottom:8px;"></div>';
        
        document.getElementById('summary-subtotal').textContent = `$${subtotal.toFixed(2)}`;
        document.getElementById('summary-delivery').textContent = `$${delivery.toFixed(2)}`;
        document.getElementById('summary-tax').textContent = `$${tax.toFixed(2)}`;
        document.getElementById('summary-total').textContent = `$${total.toFixed(2)}`;
      }
    })();

    // Initialize stores
    async function initializeStores() {
      try {
        const res = await fetch('/api/stores');
        if (!res.ok) throw new Error('Failed to fetch stores');
        allStores = await res.json();
        
        // Render pickup store options
        await renderPickupStores();
        
        // Select first store by default
        if (allStores.length > 0) {
          document.querySelector('input[name="store_pickup"]').checked = true;
          selectedStore = allStores[0].name;
          await checkInventoryForStore(selectedStore);
        }
      } catch (err) {
        console.error('Error initializing stores:', err);
      }
    }

    // Render pickup store selection
    async function renderPickupStores() {
      const container = document.getElementById('pickup-stores');
      let html = '';
      
      for (const store of allStores) {
        const availability = await getStoreAvailability(store.name);
        const availableCount = Object.values(availability).filter(Boolean).length;
        const isAvailable = availableCount === cartProductIds.length;
        
        html += `
          <label class="store-option">
            <input type="radio" name="store_pickup" value="${store.name}" ${store.id === allStores[0].id ? 'checked' : ''}>
            <div class="store-header">
              <div class="store-name">${store.name}</div>
              <span class="availability ${isAvailable ? 'available' : 'unavailable'}">
                ${availableCount}/${cartProductIds.length} in stock
              </span>
            </div>
            <div class="store-address">${store.address}</div>
            <div class="store-distance">üìç Store location</div>
          </label>
        `;
      }
      
      container.innerHTML = html;
      
      // Add event listeners
      document.querySelectorAll('input[name="store_pickup"]').forEach(radio => {
        radio.addEventListener('change', async (e) => {
          selectedStore = e.target.value;
          await checkInventoryForStore(selectedStore);
        });
      });
    }

    // Check inventory for store
    async function getStoreAvailability(storeName) {
      if (cartProductIds.length === 0) return {};
      
      try {
        const res = await fetch('/api/check-inventory', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            product_ids: cartProductIds,
            store_name: storeName
          })
        });
        
        if (!res.ok) throw new Error('Failed to check inventory');
        return await res.json();
      } catch (err) {
        console.error('Error checking inventory:', err);
        return {};
      }
    }

    // Display inventory check results
    async function checkInventoryForStore(storeName) {
      const availability = await getStoreAvailability(storeName);
      const unavailable = Object.entries(availability)
        .filter(([_, available]) => !available)
        .map(([id, _]) => cartProductIds.indexOf(parseInt(id)))
        .filter(i => i !== -1);

      const notice = document.getElementById('pickup-availability-notice');
      
      if (unavailable.length > 0) {
        notice.innerHTML = `‚ö†Ô∏è ${unavailable.length} item(s) not available at ${storeName}`;
        notice.style.display = 'block';
      } else {
        notice.style.display = 'none';
      }
    }

    // Handle delivery method toggle
    (function(){
      const radios = document.querySelectorAll('input[name="delivery_method"]');
      const addressInputs = Array.from(document.querySelectorAll('input[name="street"],input[name="city"],input[name="state"],input[name="zip"]'));
      const pickupSection = document.getElementById('pickup-stores-section');
      const deliverySection = document.getElementById('delivery-stores-section');
      const addressSection = document.getElementById('address-section');

      function update(){
        const method = (document.querySelector('input[name="delivery_method"]:checked')||{}).value;
        const isDelivery = method === 'uber';
        
        // Toggle visibility
        pickupSection.style.display = isDelivery ? 'none' : 'block';
        deliverySection.style.display = isDelivery ? 'block' : 'none';
        addressSection.style.display = isDelivery ? 'block' : 'none';
        
        // Toggle address fields
        addressInputs.forEach(i=>{
          i.disabled = !isDelivery;
          i.required = isDelivery;
        });
      }
      
      radios.forEach(r=>r.addEventListener('change', update));
      update();
    })();

    // Handle delivery address input - find closest store
    (function(){
      const addressInputs = Array.from(document.querySelectorAll('input[name="street"],input[name="city"],input[name="state"],input[name="zip"]'));
      const debounceDelay = 1500;
      let debounceTimer;

      async function findClosestStore() {
        const street = document.querySelector('input[name="street"]').value.trim();
        const city = document.querySelector('input[name="city"]').value.trim();
        const state = document.querySelector('input[name="state"]').value.trim();
        const zip = document.querySelector('input[name="zip"]').value.trim();

        if (!street || !city || !state || !zip) return;

        try {
          // Use a free geocoding service or ask for coordinates
          const address = `${street}, ${city}, ${state} ${zip}`;
          
          // Try to geocode using OSM nominatim (free, no key required)
          const geocodeRes = await fetch(
            `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(address)}&format=json&limit=1`
          );
          
          if (!geocodeRes.ok || geocodeRes.status === 429) {
            // Fallback: show all stores if rate limited
            return;
          }
          
          const geocodeData = await geocodeRes.json();
          
          if (geocodeData.length === 0) {
            document.getElementById('closest-store-info').style.display = 'none';
            return;
          }

          const lat = geocodeData[0].lat;
          const lng = geocodeData[0].lon;

          // Get closest store
          const res = await fetch(`/api/closest-store?lat=${lat}&lng=${lng}`);
          if (!res.ok) throw new Error('Failed to find closest store');
          
          const data = await res.json();
          const store = data.store;
          
          // Display closest store
          document.getElementById('closest-store-name').textContent = store.name;
          document.getElementById('closest-store-address').textContent = store.address;
          document.getElementById('closest-store-distance').textContent = data.distance_miles.toFixed(1);
          document.getElementById('closest-store-info').style.display = 'block';
          
          // Check availability at closest store
          const availability = await getStoreAvailability(store.name);
          const unavailable = Object.values(availability).filter(b => !b).length;
          
          const notice = document.getElementById('delivery-availability-notice');
          if (unavailable > 0) {
            notice.innerHTML = `‚ö†Ô∏è ${unavailable} item(s) not in stock for delivery from ${store.name}`;
            notice.style.display = 'block';
          } else {
            notice.style.display = 'none';
          }
          
        } catch (err) {
          console.error('Error finding closest store:', err);
        }
      }

      addressInputs.forEach(input => {
        input.addEventListener('input', () => {
          clearTimeout(debounceTimer);
          debounceTimer = setTimeout(findClosestStore, debounceDelay);
        });
      });
    })();

    // Initialize on page load
    window.addEventListener('load', initializeStores);
  </script>
</body>
</html>
