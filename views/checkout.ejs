<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title><%= title || 'Checkout' %></title>

  <!-- Keep your existing CSS includes if you have them -->
  <link rel="stylesheet" href="/css/checkout.css">
  <style>
    /* Minimal fallback styling so the page is usable even if checkout.css is missing */
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:#f6f7fb;color:#111;}
    .wrap{max-width:980px;margin:24px auto;padding:0 16px;display:grid;grid-template-columns:1fr 360px;gap:18px}
    @media (max-width:900px){.wrap{grid-template-columns:1fr}}
    .card{background:#fff;border:1px solid #e6e6ef;border-radius:12px;padding:16px}
    h2{margin:0 0 12px 0;font-size:18px}
    label{display:block;font-size:12px;color:#444;margin:10px 0 6px}
    input,select{width:100%;padding:10px 12px;border:1px solid #d6d6e6;border-radius:10px;font-size:14px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .btn{width:100%;padding:12px 14px;border:0;border-radius:10px;background:#4fc3df;color:#fff;font-weight:700;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .muted{color:#666;font-size:12px;margin-top:6px}
    .err{color:#b00020;font-size:13px;margin-top:10px;white-space:pre-wrap}
    .sumrow{display:flex;justify-content:space-between;margin:8px 0;font-size:14px}
    .sumrow.total{font-weight:800;font-size:16px}
    .fulfillment-hero{max-width:980px;margin:24px auto 8px auto;padding:0 16px}
    .fulfillment-hero__shell{background:linear-gradient(120deg,#10131a,#1b2f60 55%,#2f7cc6);border-radius:20px;padding:26px;display:flex;flex-wrap:wrap;gap:24px;align-items:center;box-shadow:0 15px 35px rgba(16,19,26,.35)}
    .fulfillment-hero__copy{flex:1 1 260px;color:#f2f7ff}
    .fulfillment-hero__eyebrow{display:inline-flex;align-items:center;gap:6px;font-size:12px;text-transform:uppercase;letter-spacing:.08em;padding:6px 12px;border:1px solid rgba(255,255,255,.25);border-radius:999px;margin-bottom:12px;color:#c8d9ff}
    .fulfillment-hero__title{font-size:26px;margin:0 0 8px 0;color:#fff}
    .fulfillment-hero__text{margin:0;font-size:15px;color:rgba(255,255,255,.85);line-height:1.5}
    .fulfillment-hero__store{margin-top:14px;font-size:13px;color:#c8d9ff}
    .fulfillment-options{flex:1 1 320px;display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:16px}
    .fulfillment-tile{position:relative;display:block}
    .fulfillment-tile input{position:absolute;inset:0;opacity:0;pointer-events:none}
    .fulfillment-card{background:rgba(255,255,255,.07);border:1px solid rgba(255,255,255,.25);border-radius:18px;padding:18px;min-height:130px;display:flex;flex-direction:column;justify-content:space-between;transition:transform .2s ease, border-color .2s ease, box-shadow .2s ease}
    .fulfillment-card__title{font-size:18px;font-weight:700;color:#fff;margin:0 0 6px 0}
    .fulfillment-card__desc{font-size:14px;color:rgba(255,255,255,.8);margin:0}
    .fulfillment-card__tag{font-size:13px;color:#4fc3df;font-weight:600;text-transform:uppercase;letter-spacing:.05em}
    .fulfillment-tile input:checked + .fulfillment-card{border-color:#4fc3df;box-shadow:0 12px 28px rgba(79,195,223,.35);transform:translateY(-4px)}
    .fulfillment-summary{margin-top:18px;font-size:14px;color:#dbe9ff}
    .delivery-fields{margin-top:18px;padding-top:18px;border-top:1px solid #ececf4;display:none}
    .delivery-status{margin-top:8px;font-size:12px;min-height:18px}
    @media(max-width:720px){.fulfillment-hero__shell{flex-direction:column;padding:22px}.fulfillment-options{width:100%;grid-template-columns:1fr}}
  </style>
</head>

<body>
  <section class="fulfillment-hero">
    <div class="fulfillment-hero__shell">
      <div class="fulfillment-hero__copy">
        <span class="fulfillment-hero__eyebrow">Step 1 · Fulfillment</span>
        <h1 class="fulfillment-hero__title">Pickup or delivery?</h1>
        <p class="fulfillment-hero__text">Choose how you'd like to get your order. We'll keep everything synced with Authorize.Net so you only enter your details once.</p>
        <div class="fulfillment-hero__store">Items prepared at <strong><%= (storeMeta && storeMeta.label) ? storeMeta.label : 'Miami Vape Smoke Shop' %></strong>. Need another location? Switch stores from the product catalog.</div>
        <div class="fulfillment-summary" id="deliveryNote"></div>
      </div>
      <div class="fulfillment-options">
        <label class="fulfillment-tile">
          <input type="radio" name="fulfillmentMethod" value="pickup" checked>
          <div class="fulfillment-card">
            <div>
              <p class="fulfillment-card__title">In-store pickup</p>
              <p class="fulfillment-card__desc">Pay online, grab it curbside or at the counter. We'll text you when it's ready.</p>
            </div>
            <span class="fulfillment-card__tag">Fastest</span>
          </div>
        </label>
        <label class="fulfillment-tile">
          <input type="radio" name="fulfillmentMethod" value="delivery">
          <div class="fulfillment-card">
            <div>
              <p class="fulfillment-card__title">Local delivery</p>
              <p class="fulfillment-card__desc">We’ll hand off to our runner and keep you updated every step of the way.</p>
            </div>
            <span class="fulfillment-card__tag">We drive it</span>
          </div>
        </label>
      </div>
    </div>
  </section>

  <div class="wrap">
    <!-- Left: Contact + Payment -->
    <div class="card">
      <h2>Contact</h2>

      <label>Email address</label>
      <input id="email" type="email" value="<%= (typeof user !== 'undefined' && user && user.email) ? user.email : '' %>
" placeholder="you@example.com" />

      <div class="row">
        <div>
          <label>First name</label>
          <input id="firstName" type="text" value="" placeholder="First" />
        </div>
        <div>
          <label>Last name</label>
          <input id="lastName" type="text" value="" placeholder="Last" />
        </div>
      </div>

      <label>Phone number</label>
      <input id="phoneNumber" type="tel" value="" placeholder="(xxx) xxx-xxxx" />

      <div id="deliveryFields" class="delivery-fields">
        <h2 style="margin-top:0;">Delivery Details</h2>
        <label>Street address</label>
        <input id="deliveryStreet" type="text" autocomplete="address-line1" placeholder="123 Main St" />
        <label>Apartment, suite, etc.</label>
        <input id="deliveryUnit" type="text" autocomplete="address-line2" placeholder="Unit" />
        <div class="row">
          <div>
            <label>City</label>
            <input id="deliveryCity" type="text" autocomplete="address-level2" placeholder="City" />
          </div>
          <div>
            <label>State</label>
            <input id="deliveryState" type="text" autocomplete="address-level1" placeholder="State" />
          </div>
        </div>
        <label>ZIP code</label>
        <input id="deliveryZip" type="text" inputmode="numeric" autocomplete="postal-code" placeholder="ZIP" />
        <label>Delivery notes</label>
        <input id="deliveryInstructions" type="text" placeholder="Gate code, buzzer, etc." />
      </div>

      <h2 style="margin-top:18px;">Payment</h2>

      <label>Name on card</label>
      <input id="cardName" type="text" placeholder="Name as it appears on card" />

      <label>Card number</label>
      <input id="cardNumber" type="text" inputmode="numeric" autocomplete="cc-number" placeholder="•••• •••• •••• ••••" />

      <div class="row">
        <div>
          <label>Expiration (MM/YY)</label>
          <input id="cardExp" type="text" inputmode="numeric" autocomplete="cc-exp" placeholder="MM/YY" />
        </div>
        <div>
          <label>CVV</label>
          <input id="cardCvv" type="text" inputmode="numeric" autocomplete="cc-csc" placeholder="123" />
        </div>
      </div>

      <div class="muted">Your card details are tokenized by Authorize.Net (Accept.js). We never store raw card numbers on our server.</div>
      <div id="err" class="err" style="display:none;"></div>
    </div>

    <!-- Right: Order Summary -->
    <div class="card">
      <h2>Order Summary</h2>

      <div class="sumrow"><span>Subtotal</span><span id="subtotal">$0.00</span></div>
      <div class="sumrow"><span>Tax</span><span id="tax">$0.00</span></div>
      <div class="sumrow"><span>Delivery</span><span id="delivery">$0.00</span></div>
      <div class="sumrow total"><span>Total</span><span id="total">$0.00</span></div>
      <div id="deliveryStatus" class="muted delivery-status"></div>

      <button id="completeOrderBtn" class="btn" type="button" style="margin-top:14px;">Complete Order</button>
      <div class="muted" id="authnetDebug"></div>
    </div>
  </div>

  <% const env = (authorizeEnv || '').toLowerCase(); %>
  <% if (env === 'production') { %>
    <script src="https://js.authorize.net/v1/Accept.js" charset="utf-8"></script>
  <% } else { %>
    <script src="https://jstest.authorize.net/v1/Accept.js" charset="utf-8"></script>
  <% } %>

  <script>
    // Injected by server (public values only)
    const AUTHNET = {
      loginId: "<%= (authorizeLoginId || '') %>",
      clientKey: "<%= (authorizeClientKey || '') %>",
      env: "<%= (authorizeEnv || '') %>"
    };
    const DEFAULT_STORE_LABEL = <%- JSON.stringify((storeMeta && storeMeta.label) ? storeMeta.label : (selectedShop || 'Calle 8')) %>;
    const DEFAULT_STORE_ID = <%- JSON.stringify(selectedShop || '') %>;
    const SUCCESS_STORAGE_KEY = 'checkoutSuccessPayload';
    const DELIVERY_MAX_RADIUS_MILES = 10;
    const deliveryQuoteState = { status: 'idle', fee: 0, quoteId: null, currency: 'USD', expires: null, error: '' };
    let deliveryQuoteAbort = null;
    let deliveryQuoteTimer = null;
    let deliveryGeo = null;

    function readCartItems() {
      try { return JSON.parse(localStorage.getItem('cart') || '[]'); } catch { return []; }
    }

    function normalizePrice(value) {
      if (typeof value === 'number' && Number.isFinite(value)) return value;
      const parsed = parseFloat(String(value || '').replace(/[^0-9.]/g, ''));
      return Number.isFinite(parsed) ? parsed : 0;
    }

    function buildOrderItems() {
      return readCartItems()
        .map((item) => {
          const quantity = Math.max(1, Number(item.quantity ?? item.qty ?? 1) || 1);
          const unitPrice = normalizePrice(item.price ?? item.unitPrice ?? 0);
          return {
            id: item.id || item.productId || null,
            name: item.name || item.productName || 'Item',
            flavor: item.flavor || item.variant || '',
            quantity,
            price: unitPrice,
            total: unitPrice * quantity
          };
        })
        .filter((item) => item.quantity > 0);
    }

    // Basic totals calculation from localStorage cart (adjust if your cart schema differs)
    // Expected cart item shape examples:
    // - { price: 9.99, quantity: 2 }
    // - { price: "9.99", qty: 2 }
    function getCartTotals(includeDeliveryFee = true) {
      const cart = readCartItems();
      const subtotal = cart.reduce((sum, it) => {
        const p = normalizePrice(it.price ?? it.unitPrice ?? 0);
        const q = Math.max(1, Number(it.quantity ?? it.qty ?? 1) || 1);
        if (!Number.isFinite(p) || !Number.isFinite(q)) return sum;
        return sum + (p * q);
      }, 0);

      const taxRate = 0.0875;
      const tax = subtotal * taxRate;
      const includeDelivery = includeDeliveryFee && getFulfillmentMethod() === 'delivery';
      const delivery = includeDelivery ? Math.max(0, Number(deliveryQuoteState.fee || 0)) : 0;
      const total = subtotal + tax + delivery;

      return { subtotal, tax, delivery, total };
    }

    function money(n) {
      const x = Number(n || 0);
      return '$' + (Number.isFinite(x) ? x.toFixed(2) : '0.00');
    }

    function renderTotals() {
      const t = getCartTotals();
      document.getElementById('subtotal').textContent = money(t.subtotal);
      document.getElementById('tax').textContent = money(t.tax);
      document.getElementById('delivery').textContent = money(t.delivery);
      document.getElementById('total').textContent = money(t.total);
      updateDeliveryStatus();
      return t;
    }

    function getFulfillmentMethod() {
      const checked = document.querySelector('input[name="fulfillmentMethod"]:checked');
      return checked ? checked.value : 'pickup';
    }

    function getPickupStoreLabel() {
      return DEFAULT_STORE_LABEL;
    }

    function getPickupStoreId() {
      return DEFAULT_STORE_ID;
    }

    function getContactName() {
      const first = document.getElementById('firstName').value.trim();
      const last = document.getElementById('lastName').value.trim();
      return [first, last].filter(Boolean).join(' ').trim();
    }

    function collectDeliveryAddress() {
      return {
        street1: document.getElementById('deliveryStreet').value.trim(),
        street2: document.getElementById('deliveryUnit').value.trim(),
        city: document.getElementById('deliveryCity').value.trim(),
        state: document.getElementById('deliveryState').value.trim(),
        zip: document.getElementById('deliveryZip').value.trim(),
        instructions: document.getElementById('deliveryInstructions').value.trim(),
        country: 'US'
      };
    }

    function isDeliveryAddressComplete(address) {
      return !!(address.street1 && address.city && address.state && address.zip);
    }

    function resetDeliveryQuoteState() {
      deliveryQuoteState.status = 'idle';
      deliveryQuoteState.fee = 0;
      deliveryQuoteState.quoteId = null;
      deliveryQuoteState.currency = 'USD';
      deliveryQuoteState.expires = null;
      deliveryQuoteState.error = '';
    }

    function updateDeliveryStatus() {
      const el = document.getElementById('deliveryStatus');
      if (!el) return;
      if (getFulfillmentMethod() !== 'delivery') {
        el.textContent = '';
        return;
      }
      if (deliveryQuoteState.status === 'loading') {
        el.textContent = 'Calculating delivery fee...';
        return;
      }
      if (deliveryQuoteState.status === 'error') {
        el.textContent = deliveryQuoteState.error || 'Delivery quote unavailable.';
        return;
      }
      if (deliveryQuoteState.status === 'ready') {
        el.textContent = `Delivery via Uber Direct: ${money(deliveryQuoteState.fee)}`;
        return;
      }
      el.textContent = 'Enter your delivery address to see the fee.';
    }

    function ensureDeliveryGeo() {
      if (!navigator.geolocation || deliveryGeo) return;
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          deliveryGeo = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        },
        () => {},
        { maximumAge: 300000 }
      );
    }

    function scheduleDeliveryQuote() {
      if (getFulfillmentMethod() !== 'delivery') return;
      if (deliveryQuoteTimer) clearTimeout(deliveryQuoteTimer);
      deliveryQuoteTimer = setTimeout(() => {
        requestDeliveryQuote();
      }, 500);
    }

    async function requestDeliveryQuote() {
      if (getFulfillmentMethod() !== 'delivery') return;
      const address = collectDeliveryAddress();
      if (!isDeliveryAddressComplete(address)) {
        resetDeliveryQuoteState();
        updateDeliveryStatus();
        renderTotals();
        return;
      }
      if (deliveryQuoteAbort) {
        deliveryQuoteAbort.abort();
      }
      deliveryQuoteState.status = 'loading';
      deliveryQuoteState.error = '';
      updateDeliveryStatus();
      const controller = new AbortController();
      deliveryQuoteAbort = controller;
      const phoneValue = document.getElementById('phoneNumber').value.trim();
      if (!phoneValue) {
        resetDeliveryQuoteState();
        deliveryQuoteState.status = 'error';
        deliveryQuoteState.error = 'Add a phone number for delivery updates.';
        deliveryQuoteAbort = null;
        renderTotals();
        return;
      }
      const baseTotals = getCartTotals(false);
      const payload = {
        pickupStoreId: getPickupStoreId(),
        manifestValue: baseTotals.subtotal,
        dropoff: {
          street1: address.street1,
          street2: address.street2,
          city: address.city,
          state: address.state,
          zip: address.zip,
          country: address.country,
          contactName: getContactName() || 'Customer',
          contactPhone: phoneValue,
          email: document.getElementById('email').value.trim(),
          lat: deliveryGeo ? deliveryGeo.lat : undefined,
          lng: deliveryGeo ? deliveryGeo.lng : undefined
        }
      };
      try {
        const resp = await fetch('/api/uber/quote', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
          signal: controller.signal
        });
        const data = await resp.json().catch(() => ({}));
        if (!resp.ok || !data.ok) {
          resetDeliveryQuoteState();
          deliveryQuoteState.status = 'error';
          const friendly = data.error === 'distance_exceeded'
            ? `Delivery is limited to ${data.maxMiles || DELIVERY_MAX_RADIUS_MILES} miles.`
            : (data.detail || data.error || 'Delivery quote unavailable.');
          deliveryQuoteState.error = friendly;
          deliveryQuoteAbort = null;
          renderTotals();
          return;
        }
        deliveryQuoteState.status = 'ready';
        deliveryQuoteState.fee = Number(data.fee || 0);
        deliveryQuoteState.quoteId = data.quoteId || null;
        deliveryQuoteState.currency = data.currency || 'USD';
        deliveryQuoteState.expires = data.expires || null;
        deliveryQuoteState.error = '';
        deliveryQuoteAbort = null;
        renderTotals();
      } catch (err) {
        if (err.name === 'AbortError') return;
        resetDeliveryQuoteState();
        deliveryQuoteState.status = 'error';
        deliveryQuoteState.error = 'Delivery quote failed.';
        deliveryQuoteAbort = null;
        renderTotals();
      }
    }

    function getDeliveryPayloadForServer() {
      const address = collectDeliveryAddress();
      const contact = {
        name: getContactName(),
        phone: document.getElementById('phoneNumber').value.trim(),
        email: document.getElementById('email').value.trim()
      };
      return {
        address,
        instructions: address.instructions,
        quote: deliveryQuoteState.status === 'ready'
          ? {
              quoteId: deliveryQuoteState.quoteId,
              fee: deliveryQuoteState.fee,
              currency: deliveryQuoteState.currency,
              expires: deliveryQuoteState.expires
            }
          : null,
        contact,
        contactPhone: contact.phone,
        contactEmail: contact.email,
        geo: deliveryGeo
      };
    }

    function updateFulfillmentNote() {
      const note = document.getElementById('deliveryNote');
      const method = getFulfillmentMethod();
      const storeLabel = getPickupStoreLabel();
      if (note) {
        note.textContent = method === 'pickup'
          ? `Pickup from ${storeLabel}. You'll get a text when it's ready.`
          : `Delivery from ${storeLabel}. We'll confirm the drop-off after payment.`;
      }
      const deliveryShell = document.getElementById('deliveryFields');
      if (deliveryShell) {
        deliveryShell.style.display = method === 'delivery' ? 'block' : 'none';
      }
      if (method === 'delivery') {
        ensureDeliveryGeo();
        scheduleDeliveryQuote();
      } else {
        if (deliveryQuoteAbort) {
          deliveryQuoteAbort.abort();
          deliveryQuoteAbort = null;
        }
        resetDeliveryQuoteState();
        updateDeliveryStatus();
        renderTotals();
      }
      updateDeliveryStatus();
    }

    function buildSuccessPayload(result, totals) {
      const firstName = document.getElementById('firstName').value.trim();
      const lastName = document.getElementById('lastName').value.trim();
      const email = document.getElementById('email').value.trim();
      const phoneNumber = document.getElementById('phoneNumber').value.trim();
      const fulfillmentMethod = getFulfillmentMethod();
      const storeLabel = getPickupStoreLabel();
      const storeId = getPickupStoreId();
      const deliveryDetails = fulfillmentMethod === 'delivery' ? getDeliveryPayloadForServer() : null;
      const serverDelivery = result.delivery || null;
      const deliveryWarning = result.deliveryWarning || null;
      return {
        transactionId: result.transactionId,
        authCode: result.authCode || '',
        responseCode: result.responseCode || '',
        subtotal: totals.subtotal,
        tax: totals.tax,
        delivery: totals.delivery,
        total: totals.total,
        fulfillmentMethod,
        storeLabel,
        storeId,
        items: buildOrderItems(),
        customer: {
          firstName,
          lastName,
          email,
          phoneNumber
        },
        deliveryDetails,
        serverDelivery,
        deliveryWarning,
        timestamp: Date.now()
      };
    }

    function showErr(msg) {
      const el = document.getElementById('err');
      el.style.display = 'block';
      el.textContent = msg || 'Payment failed.';
    }

    function clearErr() {
      const el = document.getElementById('err');
      el.style.display = 'none';
      el.textContent = '';
    }

    function parseExp(exp) {
      // Accepts "MM/YY" or "MM/YYYY"
      const raw = String(exp || '').trim();
      const m = raw.match(/^(\d{1,2})\s*\/\s*(\d{2,4})$/);
      if (!m) return null;
      let mm = m[1].padStart(2, '0');
      let yy = m[2];
      if (yy.length === 2) yy = '20' + yy;
      return { month: mm, year: yy };
    }

    async function submitCharge(opaqueData, totals) {
      const billing = {
        firstName: document.getElementById('firstName').value.trim(),
        lastName: document.getElementById('lastName').value.trim(),
        phoneNumber: document.getElementById('phoneNumber').value.trim(),
        address: '',
        city: '',
        state: '',
        zip: '',
        country: 'US'
      };
      const customer = { email: document.getElementById('email').value.trim() };

      const deliveryMethod = getFulfillmentMethod();
      const pickupStore = getPickupStoreLabel();
      const pickupStoreId = getPickupStoreId();

      const payload = {
        opaqueData,               // { dataDescriptor, dataValue }
        billing,
        customer,
        deliveryMethod,
        pickupStore,
        pickupStoreId,
        selectedDeliveryStore: deliveryMethod === 'delivery' ? pickupStoreId : null,
        deliveryDetails: deliveryMethod === 'delivery' ? getDeliveryPayloadForServer() : null,
        items: buildOrderItems(),
        totals
      };

      const resp = await fetch('/api/authorize/charge', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });

      const data = await resp.json().catch(() => ({}));
      if (!resp.ok || !data.ok) {
        throw new Error(data.error || 'Payment failed.');
      }
      return data;
    }

    function tokenizeAndPay() {
      clearErr();

      // Basic config sanity
      const dbg = document.getElementById('authnetDebug');
      dbg.textContent = `[checkout] authnet config { loginIdPresent: ${!!AUTHNET.loginId}, clientKeyPresent: ${!!AUTHNET.clientKey}, env: '${AUTHNET.env || 'unset'}' }`;

      if (!AUTHNET.loginId || !AUTHNET.clientKey) {
        showErr('Authorize.Net is not configured (missing loginId/clientKey).');
        return;
      }

      const totals = renderTotals();
      if (!totals || totals.total <= 0) {
        showErr('Your cart total is $0.00. Add an item before checking out.');
        return;
      }

      const exp = parseExp(document.getElementById('cardExp').value);
      if (!exp) {
        showErr('Invalid expiration date. Use MM/YY.');
        return;
      }

      if (getFulfillmentMethod() === 'delivery') {
        const deliveryAddress = collectDeliveryAddress();
        if (!isDeliveryAddressComplete(deliveryAddress)) {
          showErr('Enter your delivery address to continue.');
          return;
        }
        if (deliveryQuoteState.status !== 'ready') {
          showErr(deliveryQuoteState.error || 'Delivery fee is still calculating.');
          return;
        }
      }

      const secureData = {
        authData: {
          clientKey: AUTHNET.clientKey,
          apiLoginID: AUTHNET.loginId
        },
        cardData: {
          cardNumber: document.getElementById('cardNumber').value.replace(/\s+/g,''),
          month: exp.month,
          year: exp.year,
          cardCode: document.getElementById('cardCvv').value.trim()
        }
      };

      // Accept.js callback
      const responseHandler = async function(response) {
        try {
          if (response.messages && response.messages.resultCode === "Error") {
            const msg = (response.messages.message && response.messages.message[0] && response.messages.message[0].text) || 'Payment tokenization failed.';
            showErr(msg);
            return;
          }

          const opaqueData = response.opaqueData;
          if (!opaqueData || !opaqueData.dataDescriptor || !opaqueData.dataValue) {
            showErr('Tokenization did not return opaqueData. Please try again.');
            return;
          }

          const btn = document.getElementById('completeOrderBtn');
          btn.disabled = true;

          const result = await submitCharge(opaqueData, totals);
          const payload = buildSuccessPayload(result, totals);
          try {
            sessionStorage.setItem(SUCCESS_STORAGE_KEY, JSON.stringify(payload));
          } catch {}
          try {
            localStorage.removeItem('cart');
          } catch {}
          const params = new URLSearchParams();
          if (result.transactionId) params.set('order', result.transactionId);
          if (payload.storeId) params.set('shop', payload.storeId);
          const search = params.toString();
          window.location.href = search ? `/checkout/success?${search}` : '/checkout/success';

        } catch (e) {
          showErr(e.message || 'Payment failed.');
        } finally {
          document.getElementById('completeOrderBtn').disabled = false;
        }
      };

      if (typeof Accept === 'undefined' || !Accept.dispatchData) {
        showErr('Authorize.Net Accept.js failed to load. Please refresh and try again.');
        return;
      }

      Accept.dispatchData(secureData, responseHandler);
    }

    const fulfillmentRadios = document.querySelectorAll('input[name="fulfillmentMethod"]');
    fulfillmentRadios.forEach(radio => radio.addEventListener('change', updateFulfillmentNote));
    updateFulfillmentNote();

    ['deliveryStreet','deliveryUnit','deliveryCity','deliveryState','deliveryZip','phoneNumber'].forEach((id) => {
      const el = document.getElementById(id);
      if (el) el.addEventListener('input', scheduleDeliveryQuote);
    });

    document.getElementById('completeOrderBtn').addEventListener('click', tokenizeAndPay);
    renderTotals();
  </script>
</body>
</html>
